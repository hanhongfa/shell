## for CentOS 8

cd cloud-images
export LIBGUESTFS_BACKEND=direct

export image_name='CentOS-8-GenericCloud-8.4.2105-20210603.0.x86_64.qcow2' 

#repo
virt-customize -a $image_name --run-command 'mkdir /etc/yum.repos.d/backup'
virt-customize -a $image_name --run-command 'mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/'
virt-customize -a $image_name --upload /root/cloud-images/CentOS-8-all.repo:/etc/yum.repos.d/CentOS-8-all.repo

# update kernel and tools
virt-customize -a $image_name --install kernel-lt,qemu-guest-agent,vim,wget,unzip,jq,bash-completion,yum-utils,device-mapper-persistent-data,lvm2,openssl,socat,conntrack,ebtables,ipset,sysstat,iotop,iftop,nload,bridge-utils,bash-completion,bind-utils,nc,binutils,tree,psmisc

#enable service
virt-customize -a $image_name --run-command 'systemctl enable qemu-guest-agent' 

# 设置时区

virt-customize -a $image_name --timezone "Asia/Shanghai" 

#SSH服务
 virt-customize -a $image_name --edit '/etc/ssh/sshd_config:s/GSS/#GSS/'

#环境变量
virt-customize -a $image_name --append-line '/etc/profile:alias vi=vim'
virt-customize -a $image_name --append-line '/etc/profile:alias c="clear"'
virt-customize -a $image_name --append-line '/etc/profile:unset MAILCHECK'

#clean yum

virt-customize -a $image_name --run-command 'rm -rf /var/cache/dnf/*' 

virt-customize -a $image_name --run-command 'mkdir -p /var/lib/cloud/scripts/per-once'
virt-customize -a $image_name --upload /root/cloud-images/zstack.sh:/var/lib/cloud/scripts/per-once/zstack.sh
virt-customize -a $image_name --run-command 'chmod +x var/lib/cloud/scripts/per-once/zstack.sh'


cd /root/
export LIBGUESTFS_BACKEND=direct
export DIB_LOCAL_IMAGE="/root/cloud-images/CentOS-8-GenericCloud-8.4.2105-20210603.0.x86_64.qcow2" 
export DIB_RELEASE=8
export DIB_CLOUD_INIT_ALLOW_SSH_PWAUTH="yes"
export DIB_AVOID_PACKAGES_UPDATE=1
export image_name='CentOS-8.4-x86.qcow2'

disk-image-create -a amd64 -o  $image_name -x --image-size 80 vm base centos disable-selinux cloud-init dhcp-all-interfaces

# du -sh CentOS-8.4-x86.qcow2 
1.1G	CentOS-8.4-x86.qcow2









 
